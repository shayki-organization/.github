name: Update Dashboard

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/15 * * * *'  # Runs every 15 minutes


jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub

      - name: Update dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORGANIZATION_NAME: shayki-organization
        run: |
          python - <<EOF
          import os
          from github import Github

          # Initialize GitHub client
          g = Github(os.environ['GITHUB_TOKEN'])
          
          # Get the organization
          org = g.get_organization("$ORGANIZATION_NAME")

          # Get all repositories in the organization
          repos = org.get_repos()

          # Prepare the dashboard content
          dashboard = "# CI/CD Dashboard\n\n"
          for repo in repos:
              workflows = repo.get_workflows()
              for workflow in workflows:
                  runs = workflow.get_runs()
                  completed_runs = [run for run in runs if run.conclusion is not None]
                  if completed_runs:
                      latest_run = completed_runs[0]
                      status = latest_run.status.upper()
                      content = f"{repo.name} - {workflow.name}: {status}"
                  if runs.totalCount > 0:
                      latest_run = runs[0]
                      status = latest_run.status.upper()
                      dashboard += f"- {repo.name} - {workflow.name}: {status}\n"

          # Update the README.md file
          repo = g.get_repo("$ORGANIZATION_NAME/.github")
          contents = repo.get_contents("profile/README.md")
          repo.update_file(contents.path, "Update dashboard", dashboard, contents.sha)

          print("Dashboard updated successfully!")
          EOF

      # - name: Commit changes
      #   run: |
      #     git config --local user.email "action@github.com"
      #     git config --local user.name "GitHub Action"
      #     git add README.md
      #     git commit -m "Update dashboard" || echo "No changes to commit"
      #     git push
